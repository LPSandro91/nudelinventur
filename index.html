
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nudelinventur</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png">
  <meta name="theme-color" content="#00aaff">
  <style>
    :root {
      --azzurro: #00aaff;
      --text: #222;
      --background: #f0f8ff;
      --white: #ffffff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background);
      color: var(--text);
      display: flex;
      flex-direction: column;
    }

    header {
      background-color: var(--azzurro);
      color: var(--white);
      padding: 1rem;
      text-align: center;
      font-size: 1.8rem;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    main {
      flex: 1;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    footer {
      text-align: center;
      padding: 1rem;
      font-size: 0.9rem;
      color: #666;
      background-color: #e6f7ff;
      border-top: 1px solid #cceeff;
    }

    button {
      padding: 1rem;
      font-size: 1rem;
      background-color: var(--azzurro);
      color: var(--white);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background-color: #0090cc;
    }

    #scanner {
      width: 100%;
      max-width: 400px;
      height: 300px;
      border: 2px dashed #ccc;
      margin: 1rem auto;
      display: none;
      background-color: #fff;
    }

    .item {
      background-color: #ffffff;
      border: 1px solid #ddd;
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>

<header>NudelInventur</header>

<main>
  <button onclick="startScan()">üì∑ Neue Nudel scannen</button>
  <button onclick="zeigeListe()">üìã Inventarliste anzeigen</button>
  <button onclick="resetDaten()">üóëÔ∏è Alle Daten l√∂schen</button>

  <div id="scanner"></div>
  <div id="liste"></div>
</main>

<footer>Version: 1.2.0</footer>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  let nudeln = JSON.parse(localStorage.getItem('nudeln')) || [];
  let barcodeDB = JSON.parse(localStorage.getItem('barcodeDB')) || {};

  function startScan() {
    document.getElementById('scanner').style.display = 'block';
    const qr = new Html5Qrcode("scanner");

    qr.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (code) => {
        qr.stop().then(() => {
          document.getElementById('scanner').style.display = 'none';
          neueNudel(code);
        });
      },
      (err) => {
        console.warn("Scan-Fehler", err);
      }
    ).catch(err => {
      alert("Fehler beim Starten des Scanners: " + err);
    });
  }

  function neueNudel(code) {
    const lokalVorschlag = barcodeDB[code];

    if (lokalVorschlag) {
      if (confirm(`Ist das "${lokalVorschlag}"?`)) {
        speichereNudel(code, lokalVorschlag);
        return;
      }
    }

    fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`)
      .then(res => res.json())
      .then(data => {
        let produkt = data.product || {};
        const name =
          produkt.product_name_de ||
          produkt.product_name_en ||
          produkt.product_name_fr ||
          produkt.product_name ||
          "Unbekanntes Produkt";

        if (data.status === 1 && name) {
          if (confirm(`Ist das "${name}"?`)) {
            barcodeDB[code] = name;
            localStorage.setItem("barcodeDB", JSON.stringify(barcodeDB));
            speichereNudel(code, name);
            return;
          }
        }

        const eigeneEingabe = prompt("Welche Nudelsorte ist das?");
        if (eigeneEingabe) {
          barcodeDB[code] = eigeneEingabe;
          localStorage.setItem("barcodeDB", JSON.stringify(barcodeDB));
          speichereNudel(code, eigeneEingabe);
        }
      })
      .catch(err => {
        console.error("Fehler bei Web-Abfrage:", err);
        const eigeneEingabe = prompt("Welche Nudelsorte ist das?");
        if (eigeneEingabe) {
          barcodeDB[code] = eigeneEingabe;
          localStorage.setItem("barcodeDB", JSON.stringify(barcodeDB));
          speichereNudel(code, eigeneEingabe);
        }
      });
  }

  function speichereNudel(code, typ) {
    const menge = prompt("Wie viel ist davon da?");
    if (!menge) return;
    nudeln.push({
      code,
      typ,
      menge,
      datum: new Date().toLocaleDateString()
    });
    localStorage.setItem('nudeln', JSON.stringify(nudeln));
    alert("Nudel gespeichert!");
  }

  function zeigeListe() {
    const div = document.getElementById('liste');
    div.innerHTML = "<h2>Inventarliste</h2>";
    if (nudeln.length === 0) {
      div.innerHTML += "<p>Keine Nudeln erfasst.</p>";
    } else {
      nudeln.forEach(n => {
        div.innerHTML += `<div class="item">${n.typ} ‚Äì ${n.menge} <br><small>Erfasst am ${n.datum}</small></div>`;
      });
    }
  }

  function resetDaten() {
    if (confirm("Willst du wirklich alle erfassten Nudeln l√∂schen?")) {
      localStorage.removeItem('nudeln');
      localStorage.removeItem('barcodeDB');
      nudeln = [];
      barcodeDB = {};
      zeigeListe();
    }
  }

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(() => console.log("Service Worker registriert!"))
      .catch(err => console.error("Fehler beim Registrieren:", err));
  }
</script>

</body>
</html>
